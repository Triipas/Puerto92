@* Modal para Carga Masiva de Productos *@

<div id="cargaMasivaModal" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 700px;">
        <div class="modal-header">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div style="background: #10B981; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
                    <i class="fa-solid fa-file-import"></i>
                </div>
                <div>
                    <h2 class="modal-title">Carga Masiva de Productos</h2>
                    <p class="modal-subtitle">Importe múltiples productos desde un archivo CSV</p>
                </div>
            </div>
            <button class="modal-close" onclick="closeModal('cargaMasivaModal')">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Paso 1: Descargar Plantilla -->
            <div style="background: #EFF6FF; border: 1px solid #BFDBFE; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <div style="background: #3B82F6; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; flex-shrink: 0;">
                        1
                    </div>
                    <div>
                        <h3 style="font-size: 16px; font-weight: 600; color: #1E40AF; margin: 0;">Descargar Plantilla</h3>
                        <p style="font-size: 13px; color: #1E40AF; margin: 0.25rem 0 0 0;">Descargue la plantilla CSV con las columnas correctas</p>
                    </div>
                </div>
                <a href="@Url.Action("DescargarPlantilla", "Productos")" class="btn btn-primary" style="width: 100%; justify-content: center;">
                    <i class="fa-solid fa-download"></i>
                    Descargar Plantilla CSV
                </a>
                <div style="margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 6px;">
                    <p style="font-size: 12px; color: #1E40AF; margin: 0 0 0.5rem 0; font-weight: 600;">Columnas de la plantilla:</p>
                    <ul style="font-size: 12px; color: #1E40AF; margin: 0; padding-left: 1.25rem;">
                        <li><strong>Código:</strong> Dejar vacío para autogeneración</li>
                        <li><strong>Nombre:</strong> Nombre descriptivo del producto (obligatorio)</li>
                        <li><strong>Categoría:</strong> Nombre EXACTO de categoría existente (obligatorio)</li>
                        <li><strong>Unidad:</strong> Unidad, Kilogramo, Litro, Caja, Docena, Bolsa o Paquete (obligatorio)</li>
                        <li><strong>PrecioCompra:</strong> Precio de compra en soles (obligatorio, > 0)</li>
                        <li><strong>PrecioVenta:</strong> Precio de venta en soles (obligatorio, >= PrecioCompra)</li>
                        <li><strong>Descripción:</strong> Información adicional (opcional)</li>
                    </ul>
                </div>
            </div>

            <!-- Paso 2: Subir Archivo -->
            <div style="background: #ECFDF5; border: 1px solid #A7F3D0; border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <div style="background: #10B981; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; flex-shrink: 0;">
                        2
                    </div>
                    <div>
                        <h3 style="font-size: 16px; font-weight: 600; color: #047857; margin: 0;">Subir Archivo Completado</h3>
                        <p style="font-size: 13px; color: #047857; margin: 0.25rem 0 0 0;">Complete la plantilla y súbala para procesar</p>
                    </div>
                </div>
                <form asp-action="CargaMasiva" asp-controller="Productos" method="post" enctype="multipart/form-data">
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <div style="border: 2px dashed #A7F3D0; border-radius: 8px; padding: 2rem; text-align: center; background: white; transition: all 0.2s;" 
                             id="dropzone"
                             ondragover="event.preventDefault(); this.style.borderColor='#10B981'; this.style.background='#F0FDF4';" 
                             ondragleave="this.style.borderColor='#A7F3D0'; this.style.background='white';" 
                             ondrop="handleDrop(event)">
                            <i class="fa-solid fa-cloud-arrow-up" style="font-size: 48px; color: #10B981; margin-bottom: 1rem;"></i>
                            <p style="font-size: 14px; color: #047857; margin-bottom: 0.5rem; font-weight: 500;">
                                Haga clic para seleccionar un archivo CSV
                            </p>
                            <p style="font-size: 12px; color: #059669; margin: 0;">
                                o arrastre el archivo aquí
                            </p>
                            <input type="file" name="archivo" id="archivoInput" accept=".csv" required 
                                   style="display: none;" 
                                   onchange="mostrarNombreArchivo(this)" />
                            <button type="button" onclick="document.getElementById('archivoInput').click()" 
                                    style="margin-top: 1rem; padding: 0.5rem 1rem; background: #10B981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                Seleccionar Archivo
                            </button>
                            <div id="nombreArchivo" style="margin-top: 1rem; font-size: 13px; color: #047857; font-weight: 600;"></div>
                        </div>
                    </div>

                    <!-- Validaciones -->
                    <div style="background: white; border: 1px solid #D1FAE5; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                        <p style="font-size: 12px; color: #047857; margin: 0 0 0.5rem 0; font-weight: 600;">El sistema validará:</p>
                        <ul style="font-size: 11px; color: #059669; margin: 0; padding-left: 1.25rem;">
                            <li>Archivo CSV con formato correcto (punto y coma como separador)</li>
                            <li>Categorías: deben existir en el sistema y estar activas</li>
                            <li>Unidades válidas (según lista permitida)</li>
                            <li>Precios mayores a 0 y <strong>PrecioVenta >= PrecioCompra</strong></li>
                            <li>Nombres obligatorios en cada fila</li>
                            <li>Códigos únicos (si se proporcionan)</li>
                        </ul>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                        <i class="fa-solid fa-upload"></i>
                        Importar Productos
                    </button>
                </form>
            </div>

            <!-- Advertencia -->
            <div style="background: #FEF3C7; border-left: 3px solid #F59E0B; padding: 0.875rem; border-radius: 4px; margin-top: 1.5rem;">
                <div style="display: flex; align-items: start; gap: 0.5rem;">
                    <i class="fa-solid fa-exclamation-triangle" style="color: #F59E0B; margin-top: 2px;"></i>
                    <div>
                        <p style="font-size: 13px; color: #92400E; margin: 0; font-weight: 600;">Importante:</p>
                        <ul style="font-size: 12px; color: #78350F; margin: 0.25rem 0 0 0; padding-left: 1.25rem;">
                            <li>Si el archivo contiene errores, <strong>NO se importará ningún producto</strong></li>
                            <li>Las <strong>categorías deben existir previamente</strong> en el sistema</li>
                            <li>Los productos importados estarán <strong>activos inmediatamente</strong> en todos los locales</li>
                            <li>Revise el mensaje de validación para identificar errores</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeModal('cargaMasivaModal')">Cerrar</button>
        </div>
    </div>
</div>

<script>
function handleDrop(event) {
    event.preventDefault();
    event.currentTarget.style.borderColor = '#A7F3D0';
    event.currentTarget.style.background = 'white';
    
    const files = event.dataTransfer.files;
    if (files.length > 0 && files[0].name.endsWith('.csv')) {
        document.getElementById('archivoInput').files = files;
        mostrarNombreArchivo(document.getElementById('archivoInput'));
    } else {
        alert('Por favor, seleccione un archivo CSV válido');
    }
}

function mostrarNombreArchivo(input) {
    const nombreArchivo = document.getElementById('nombreArchivo');
    if (input.files && input.files[0]) {
        nombreArchivo.innerHTML = `
            <i class="fa-solid fa-file-csv" style="color: #10B981;"></i>
            Archivo seleccionado: <strong>${input.files[0].name}</strong>
        `;
    }
}
</script>