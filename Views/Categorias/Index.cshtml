@model IEnumerable<Puerto92.ViewModels.CategoriaViewModel>
@{
    ViewData["Title"] = "Gesti칩n de Categor칤as";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    var tipoActual = ViewBag.TipoActual as string ?? "Bebidas";
    var tiposTodos = ViewBag.TiposTodos as string[] ?? new string[0];
    var estadisticas = ViewBag.Estadisticas as Dictionary<string, int> ?? new Dictionary<string, int>();
}

<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">Gesti칩n de Categor칤as</h1>
    <p class="page-subtitle">Organizar productos y utensilios seg칰n clasificaciones operativas</p>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fa-solid fa-list"></i>
        </div>
        <div class="stat-content">
            <h3>@estadisticas.Values.Sum()</h3>
            <p>Total Categor칤as</p>
            <small style="color: #64748B;">En todos los tipos</small>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon success">
            <i class="fa-solid fa-wine-glass"></i>
        </div>
        <div class="stat-content">
            <h3>@(estadisticas.ContainsKey("Bebidas") ? estadisticas["Bebidas"] : 0)</h3>
            <p>Bebidas</p>
            <small style="color: #64748B;">Categor칤as activas</small>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon warning">
            <i class="fa-solid fa-utensils"></i>
        </div>
        <div class="stat-content">
            <h3>@(estadisticas.ContainsKey("Cocina") ? estadisticas["Cocina"] : 0)</h3>
            <p>Cocina</p>
            <small style="color: #64748B;">Categor칤as activas</small>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon danger">
            <i class="fa-solid fa-kitchen-set"></i>
        </div>
        <div class="stat-content">
            <h3>@(estadisticas.ContainsKey("Utensilios") ? estadisticas["Utensilios"] : 0)</h3>
            <p>Utensilios</p>
            <small style="color: #64748B;">Categor칤as activas</small>
        </div>
    </div>
</div>

<!-- Content Card -->
<div class="content-card">
    <div class="card-header">
        <div>
            <h2 class="card-title">Lista de Categor칤as</h2>
            <p style="font-size: 13px; color: #64748B; margin-top: 4px;">
                @Model.Count() categor칤a(s) en @tipoActual
            </p>
        </div>
        <button onclick="openCreateCategoriaModal()" class="btn btn-primary">
            <i class="fa-solid fa-plus"></i>
            Nueva Categor칤a
        </button>
    </div>

    <div class="card-body">
        <!-- Tabs de Tipos -->
        <div class="categoria-tabs">
            @foreach (var tipo in tiposTodos)
            {
                var activeClass = tipo == tipoActual ? "active" : "";
                var icon = tipo == "Bebidas" ? "wine-glass" : (tipo == "Cocina" ? "utensils" : "kitchen-set");
                var count = estadisticas.ContainsKey(tipo) ? estadisticas[tipo] : 0;
                
                <a href="@Url.Action("Index", "Categorias", new { tipo = tipo })" 
                   class="categoria-tab @activeClass"
                   data-navigate>
                    <i class="fa-solid fa-@icon"></i>
                    <span>@tipo</span>
                    <span class="tab-badge">@count</span>
                </a>
            }
        </div>

        <!-- Buscador -->
        <div style="margin: 1.5rem 0;">
            <input type="text" 
                   id="searchInput" 
                   class="form-control" 
                   placeholder="游댌 Buscar categor칤as..." 
                   style="max-width: 400px;" />
        </div>

        @if (!Model.Any())
        {
            <div class="empty-state">
                <i class="fa-solid fa-folder-open"></i>
                <h3>No hay categor칤as en @tipoActual</h3>
                <p>Comienza creando tu primera categor칤a para este tipo.</p>
                <button onclick="openCreateCategoriaModal()" class="btn btn-primary">
                    <i class="fa-solid fa-plus"></i>
                    Crear Primera Categor칤a
                </button>
            </div>
        }
        else
        {
            <!-- Tabla -->
            <div class="table-responsive">
                <table class="table categoria-table" id="categoriasTable">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Orden</th>
                            <th>Nombre de Categor칤a</th>
                            <th style="width: 150px; text-align: center;">Productos</th>
                            <th style="width: 100px;">Estado</th>
                            <th style="width: 150px; text-align: center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="sortableCategoriasTable">
                        @foreach (var categoria in Model)
                        {
                            <tr data-categoria-id="@categoria.Id" data-orden="@categoria.Orden">
                                <td>
                                    <div class="orden-cell">
                                        <i class="fa-solid fa-grip-vertical drag-handle"></i>
                                        <span class="orden-number">@categoria.Orden</span>
                                    </div>
                                </td>
                                <td style="font-weight: 500;">@categoria.Nombre</td>
                                <td style="text-align: center;">
                                    @if (categoria.CantidadProductos > 0)
                                    {
                                        <span class="badge badge-success">@categoria.CantidadProductos producto(s)</span>
                                    }
                                    else
                                    {
                                        <span style="color: #94A3B8; font-size: 13px;">Sin productos</span>
                                    }
                                </td>
                                <td>
                                    @if (categoria.Activo)
                                    {
                                        <span class="badge badge-success">Activo</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-danger">Inactivo</span>
                                    }
                                </td>
                                <td style="text-align: center;">
                                    <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                        <!-- Bot칩n Editar -->
                                        <button onclick="openEditCategoriaModal(@categoria.Id)" 
                                                class="btn-icon btn-icon-edit" 
                                                title="Editar categor칤a">
                                            <i class="fa-regular fa-pen-to-square"></i>
                                        </button>

                                        <!-- Bot칩n Eliminar -->
                                        <button onclick="openDeleteCategoriaModal(@categoria.Id, '@categoria.Nombre', @categoria.CantidadProductos, '@tipoActual')" 
                                                class="btn-icon btn-icon-delete" 
                                                title="Eliminar categor칤a">
                                            <i class="fa-regular fa-trash-can"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Nota sobre reordenamiento -->
            <div style="background: #EFF6FF; border-left: 3px solid #3B82F6; padding: 0.75rem; border-radius: 4px; margin-top: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; color: #1E40AF; font-size: 13px;">
                    <i class="fa-solid fa-info-circle"></i>
                    <span><strong>Tip:</strong> Arrastra y suelta las filas usando el 칤cono <i class="fa-solid fa-grip-vertical" style="font-size: 11px;"></i> para cambiar el orden de visualizaci칩n.</span>
                </div>
            </div>
        }
    </div>
</div>

<!-- Cargar Modales -->
<partial name="Modals/_CreateCategoriaModal" model="@tipoActual" />
<partial name="Modals/_EditCategoriaModal" />
<partial name="Modals/_DeleteCategoriaModal" />

@section Styles {
    <link rel="stylesheet" href="~/css/categorias.css" asp-append-version="true" />
}

@section Scripts {
    <!-- SortableJS para drag & drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="~/js/categorias-modals.js" asp-append-version="true"></script>
}