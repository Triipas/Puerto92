@model Puerto92.ViewModels.KardexBebidasViewModel
@{
    ViewData["Title"] = "Kardex de Bebidas - Conteo por Ubicación";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="page-header">
    <div>
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
            <i class="fa-solid fa-wine-glass" style="color: #8B5CF6; font-size: 24px;"></i>
            <h1 class="page-title">Kardex de Bebidas - Conteo por Ubicación</h1>
        </div>
        <p class="page-subtitle">
            @Model.Fecha.ToString("dddd, dd 'de' MMMM 'de' yyyy") - @Model.EmpleadoNombre
        </p>
    </div>
</div>

<!-- Barra de progreso -->
<div class="kardex-progress-bar">
    <div class="progress-info">
        <span class="progress-label">Progreso del registro</span>
        <span class="progress-value">@Model.ProductosCompletos de @Model.TotalProductos productos</span>
    </div>
    <div class="progress-track">
        <div class="progress-fill" style="width: @Model.PorcentajeAvance%"></div>
    </div>
    <div class="progress-stats">
        <div class="stat-item">
            <i class="fa-solid fa-check-circle" style="color: #10B981;"></i>
            <span>@Model.ProductosCompletos completados</span>
        </div>
        @if (Model.ProductosConDiferencia > 0)
        {
            <div class="stat-item">
                <i class="fa-solid fa-exclamation-triangle" style="color: #F59E0B;"></i>
                <span>@Model.ProductosConDiferencia con diferencias</span>
            </div>
        }
        <div class="stat-item">
            <span id="autoguardadoIndicador" class="autoguardado-indicator">
                <i class="fa-solid fa-circle-check"></i>
                Guardado
            </span>
        </div>
    </div>
</div>

<!-- Filtros y búsqueda -->
<div class="content-card" style="margin-bottom: 1rem;">
    <div class="card-body" style="padding: 1rem;">
        <div style="display: flex; gap: 1rem; align-items: center;">
            <div style="flex: 1; max-width: 400px;">
                <div class="search-box">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" 
                           id="searchProducto" 
                           class="form-control" 
                           placeholder="Buscar por código o nombre..."
                           style="padding-left: 2.5rem;" />
                </div>
            </div>
            <div>
                <select id="filtroCategorias" class="form-select">
                    <option value="">Todas las categorías</option>
                </select>
            </div>
            <div style="margin-left: auto;">
                <button type="button" class="btn btn-secondary" onclick="recalcularTodo()">
                    <i class="fa-solid fa-calculator"></i>
                    Recalcular
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de conteo -->
<div class="content-card">
    <div class="kardex-table-container">
        <table class="kardex-table" id="kardexTable">
            <thead>
                <tr>
                    <th style="width: 100px;">Categoría</th>
                    <th style="width: 80px;">Código</th>
                    <th style="width: 200px;">Descripción</th>
                    <th style="width: 70px;">Unidad</th>
                    <th style="width: 80px;">Inv. Inicial</th>
                    <th style="width: 80px;">Ingresos</th>
                    <th style="width: 90px;">Almacén</th>
                    <th style="width: 90px;">Refri 1</th>
                    <th style="width: 90px;">Refri 2</th>
                    <th style="width: 90px;">Refri 3</th>
                    <th style="width: 90px;">Conteo Final</th>
                    <th style="width: 80px;">Ventas</th>
                </tr>
            </thead>
            <tbody id="kardexTableBody">
                @foreach (var detalle in Model.Detalles)
                {
                    var rowClass = detalle.TieneDiferenciaSignificativa ? "row-diferencia" : "";
                    var completeClass = detalle.EstaCompleto ? "row-complete" : "";
                    
                    <tr class="@rowClass @completeClass" data-detalle-id="@detalle.Id" data-categoria="@detalle.Categoria">
                        <td class="td-categoria">@detalle.Categoria</td>
                        <td class="td-codigo">@detalle.Codigo</td>
                        <td class="td-descripcion">@detalle.Descripcion</td>
                        <td class="td-unidad">@detalle.Unidad</td>
                        <td class="td-readonly">@detalle.InventarioInicial.ToString("0.##")</td>
                        <td class="td-readonly">@detalle.Ingresos.ToString("0.##")</td>
                        <td class="td-editable">
                            <input type="number" 
                                   class="input-conteo" 
                                   data-campo="ConteoAlmacen"
                                   data-detalle-id="@detalle.Id"
                                   value="@(detalle.ConteoAlmacen?.ToString("0.##") ?? "")"
                                   step="0.01"
                                   min="0"
                                   placeholder="0" />
                        </td>
                        <td class="td-editable">
                            <input type="number" 
                                   class="input-conteo" 
                                   data-campo="ConteoRefri1"
                                   data-detalle-id="@detalle.Id"
                                   value="@(detalle.ConteoRefri1?.ToString("0.##") ?? "")"
                                   step="0.01"
                                   min="0"
                                   placeholder="0" />
                        </td>
                        <td class="td-editable">
                            <input type="number" 
                                   class="input-conteo" 
                                   data-campo="ConteoRefri2"
                                   data-detalle-id="@detalle.Id"
                                   value="@(detalle.ConteoRefri2?.ToString("0.##") ?? "")"
                                   step="0.01"
                                   min="0"
                                   placeholder="0" />
                        </td>
                        <td class="td-editable">
                            <input type="number" 
                                   class="input-conteo" 
                                   data-campo="ConteoRefri3"
                                   data-detalle-id="@detalle.Id"
                                   value="@(detalle.ConteoRefri3?.ToString("0.##") ?? "")"
                                   step="0.01"
                                   min="0"
                                   placeholder="0" />
                        </td>
                        <td class="td-calculado td-conteo-final">
                            @detalle.ConteoFinal.ToString("0.##")
                        </td>
                        <td class="td-calculado td-ventas">
                            @detalle.Ventas.ToString("0.##")
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Botones de acción -->
<div class="content-card" style="margin-top: 1rem;">
    <div class="card-body">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <a asp-action="MiKardex" class="btn btn-secondary">
                <i class="fa-solid fa-arrow-left"></i>
                Volver
            </a>
            <button type="button" class="btn btn-primary" onclick="openCompletarModal()" id="btnCompletar">
                <i class="fa-solid fa-check"></i>
                Completar Kardex
            </button>
        </div>
    </div>
</div>

<!-- Modal de completar -->
<div id="completarKardexModal" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 540px;">
        <div class="modal-header">
            <div>
                <h2 class="modal-title">Completar Kardex de Bebidas</h2>
                <p class="modal-subtitle">Revisa antes de enviar</p>
            </div>
            <button class="modal-close" onclick="closeModal('completarKardexModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="validacionResultado"></div>
            
            <div class="form-group">
                <label class="form-label">Observaciones generales (opcional)</label>
                <textarea id="observacionesGenerales" 
                          class="form-control" 
                          rows="3"
                          placeholder="Ej: Faltaron 3 cervezas por rotura..."
                          maxlength="500"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeModal('completarKardexModal')">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnConfirmarCompletar" onclick="confirmarCompletar()">
                <i class="fa-solid fa-paper-plane"></i>
                Enviar Kardex
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const KARDEX_ID = @Model.Id;
    </script>
    <script src="~/js/kardex-bebidas.js" asp-append-version="true"></script>
}