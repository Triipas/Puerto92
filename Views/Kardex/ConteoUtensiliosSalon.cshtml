@model Puerto92.ViewModels.KardexSalonViewModel
@{
    ViewData["Title"] = "Kardex de Salón - Utensilios";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="page-header">
    <div>
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
            <i class="fa-solid fa-utensils" style="color: #10B981; font-size: 24px;"></i>
            <h1 class="page-title">Kardex de Utensilios de Salón</h1>
        </div>
        <p class="page-subtitle">
            @Model.Fecha.ToString("dddd, dd 'de' MMMM 'de' yyyy") - @Model.EmpleadoNombre
        </p>
    </div>
</div>

<!-- Instrucciones de conteo -->
<div class="content-card" style="margin-bottom: 1.5rem;">
    <div class="card-body" style="background: #EFF6FF; border-left: 3px solid #0092B8;">
        <div style="display: flex; align-items: start; gap: 0.75rem;">
            <i class="fa-solid fa-lightbulb" style="color: #0092B8; font-size: 20px; margin-top: 2px;"></i>
            <div>
                <h3 style="font-size: 15px; font-weight: 600; color: #0C4A6E; margin-bottom: 0.5rem;">
                    Instrucciones de conteo
                </h3>
                <p style="font-size: 13px; color: #075985; margin: 0; line-height: 1.6;">
                    Registre las cantidades exactas de cada utensilio encontrado al final del día. 
                    Los cambios se guardan automáticamente cada 2 segundos. 
                    Si detecta utensilios rotos o extraviados, deberá especificar qué pasó con ellos al finalizar.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Barra de progreso -->
<div class="kardex-progress-bar">
    <div class="progress-info">
        <span class="progress-label">Progreso del registro</span>
        <span class="progress-value">@Model.UtensiliosCompletos de @Model.TotalUtensilios utensilios</span>
    </div>
    <div class="progress-track">
        <div class="progress-fill" style="width: @Model.PorcentajeAvance%"></div>
    </div>
    <div class="progress-stats">
        <div class="stat-item">
            <i class="fa-solid fa-check-circle" style="color: #10B981;"></i>
            <span>@Model.UtensiliosCompletos completados</span>
        </div>
        @if (Model.UtensiliosConFaltantes > 0)
        {
            <div class="stat-item">
                <i class="fa-solid fa-exclamation-triangle" style="color: #F59E0B;"></i>
                <span>@Model.UtensiliosConFaltantes con faltantes</span>
            </div>
        }
        <div class="stat-item">
            <span id="autoguardadoIndicador" class="autoguardado-indicator">
                <i class="fa-solid fa-circle-check"></i>
                Guardado
            </span>
        </div>
    </div>
</div>

<!-- Filtros y búsqueda -->
<div class="content-card" style="margin-bottom: 1rem;">
    <div class="card-body" style="padding: 1rem;">
        <div style="display: flex; gap: 1rem; align-items: center;">
            <div style="flex: 1; max-width: 400px;">
                <div class="search-box">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" 
                           id="searchUtensilio" 
                           class="form-control" 
                           placeholder="Buscar por número o descripción..."
                           style="padding-left: 2.5rem;" />
                </div>
            </div>
            <div>
                <select id="filtroCategorias" class="form-select">
                    <option value="">Todas las categorías</option>
                </select>
            </div>
            <div style="margin-left: auto;">
                <button type="button" class="btn btn-secondary" onclick="recalcularTodo()">
                    <i class="fa-solid fa-calculator"></i>
                    Recalcular
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de conteo -->
<div class="content-card">
    <div class="kardex-table-container">
        <table class="kardex-table-salon" id="kardexTable">
            <thead>
                <tr>
                    <th style="width: 80px;">Número</th>
                    <th style="width: 300px;">Descripción del Utensilio</th>
                    <th style="width: 120px;">Unidades</th>
                </tr>
            </thead>
            <tbody id="kardexTableBody">
                @foreach (var detalle in Model.Detalles)
                {
                    var rowClass = detalle.TieneFaltantes ? "row-faltante" : "";
                    var completeClass = detalle.EstaCompleto ? "row-complete" : "";
                    
                    <tr class="@rowClass @completeClass" 
                        data-detalle-id="@detalle.Id" 
                        data-categoria="@detalle.Categoria"
                        data-inventario-inicial="@detalle.InventarioInicial">
                        <td class="td-numero">@detalle.Orden</td>
                        <td class="td-descripcion">@detalle.Descripcion</td>
                        <td class="td-editable">
                            <input type="number" 
                                   class="input-unidades" 
                                   data-detalle-id="@detalle.Id"
                                   value="@(detalle.UnidadesContadas?.ToString() ?? "")"
                                   step="1"
                                   min="0"
                                   placeholder="0" />
                            @if (detalle.TieneFaltantes)
                            {
                                <span class="faltante-badge">
                                    <i class="fa-solid fa-exclamation-triangle"></i>
                                    Faltan @detalle.Diferencia
                                </span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Botones de acción -->
<div class="content-card" style="margin-top: 1rem;">
    <div class="card-body">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <a asp-action="MiKardex" class="btn btn-secondary">
                <i class="fa-solid fa-arrow-left"></i>
                Volver
            </a>
            <button type="button" class="btn btn-primary" onclick="openCompletarModal()" id="btnCompletar">
                <i class="fa-solid fa-arrow-right"></i>
                Siguiente
            </button>
        </div>
    </div>
</div>

<!-- Modal de completar -->
<div id="completarKardexModal" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 600px;">
        <div class="modal-header">
            <div>
                <h2 class="modal-title">Completar Kardex de Salón</h2>
                <p class="modal-subtitle">Revisa antes de continuar al registro de personal</p>
            </div>
            <button class="modal-close" onclick="closeModal('completarKardexModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="validacionResultado"></div>
            
            <!-- Campo OBLIGATORIO de descripción de faltantes -->
            <div class="form-group" id="seccionDescripcionFaltantes" style="display: none;">
                <label class="form-label">
                    Descripción de Faltantes (Requerido) <span style="color: #EF4444;">*</span>
                </label>
                <textarea id="descripcionFaltantes" 
                          class="form-control" 
                          rows="4"
                          placeholder="Ejemplo: 3 platos tendidos rotos durante el servicio, 2 copas de vino tinto extraviadas, 1 mantel manchado enviado a lavandería..."
                          maxlength="1000"
                          required></textarea>
                <small style="color: #64748B; font-size: 12px; display: block; margin-top: 0.375rem;">
                    Especifique qué pasó con cada utensilio faltante (rotos, extraviados, etc.)
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Observaciones adicionales (opcional)</label>
                <textarea id="observacionesGenerales" 
                          class="form-control" 
                          rows="3"
                          placeholder="Ej: Turno tranquilo, sin incidentes..."
                          maxlength="500"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeModal('completarKardexModal')">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnConfirmarCompletar" onclick="confirmarCompletar()">
                <i class="fa-solid fa-arrow-right"></i>
                Siguiente: Personal Presente
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const KARDEX_ID = @Model.Id;
    </script>
    <script src="~/js/kardex-salon.js" asp-append-version="true"></script>
}