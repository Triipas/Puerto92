@model Puerto92.ViewModels.KardexSalonViewModel
@{
    ViewData["Title"] = "Kardex de Utensilios de Salón";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="page-header">
    <div>
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
            <i class="fa-solid fa-utensils" style="color: #10B981; font-size: 24px;"></i>
            <h1 class="page-title">Kardex de Utensilios de Salón</h1>
        </div>
        <p class="page-subtitle">
            @Model.Fecha.ToString("dddd, dd 'de' MMMM 'de' yyyy") - @Model.EmpleadoNombre
        </p>
    </div>
</div>

<!-- Instrucciones de Conteo -->
<div class="content-card" style="margin-bottom: 1.5rem;">
    <div class="card-body" style="background: #DBEAFE; border-left: 3px solid #3B82F6;">
        <div style="display: flex; align-items: start; gap: 0.75rem;">
            <i class="fa-solid fa-info-circle" style="color: #3B82F6; font-size: 20px; margin-top: 2px;"></i>
            <div>
                <h3 style="font-size: 15px; font-weight: 600; color: #1E40AF; margin-bottom: 0.5rem;">
                    Instrucciones de conteo
                </h3>
                <p style="font-size: 13px; color: #1E40AF; margin: 0; line-height: 1.6;">
                    Registre las cantidades exactas de cada utensilio encontrado al final del día. 
                    Si detecta utensilios rotos o extraviados, deberá justificar los faltantes especificando qué pasó con ellos.
                    Los cambios se guardan automáticamente cada 2 segundos.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Barra de progreso -->
<div class="kardex-progress-bar">
    <div class="progress-info">
        <span class="progress-label">Progreso del registro</span>
        <span class="progress-value">@Model.UtensiliosCompletos de @Model.TotalUtensilios utensilios</span>
    </div>
    <div class="progress-track">
        <div class="progress-fill" style="width: @Model.PorcentajeAvance%"></div>
    </div>
    <div class="progress-stats">
        <div class="stat-item">
            <i class="fa-solid fa-check-circle" style="color: #10B981;"></i>
            <span>@Model.UtensiliosCompletos completados</span>
        </div>
        @if (Model.UtensiliosConFaltantes > 0)
        {
            <div class="stat-item">
                <i class="fa-solid fa-exclamation-triangle" style="color: #F59E0B;"></i>
                <span>@Model.UtensiliosConFaltantes con faltantes</span>
            </div>
        }
        <div class="stat-item">
            <span id="autoguardadoIndicador" class="autoguardado-indicator">
                <i class="fa-solid fa-circle-check"></i>
                Guardado
            </span>
        </div>
    </div>
</div>

<!-- Filtros y búsqueda -->
<div class="content-card" style="margin-bottom: 1rem;">
    <div class="card-body" style="padding: 1rem;">
        <div style="display: flex; gap: 1rem; align-items: center;">
            <div style="flex: 1; max-width: 400px;">
                <div class="search-box">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" 
                           id="searchUtensilio" 
                           class="form-control" 
                           placeholder="Buscar por código o nombre..."
                           style="padding-left: 2.5rem;" />
                </div>
            </div>
            <div>
                <select id="filtroCategorias" class="form-select">
                    <option value="">Todas las categorías</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de utensilios -->
<div class="content-card">
    <div class="kardex-table-container">
        <table class="kardex-table" id="kardexTable">
            <thead>
                <tr>
                    <th style="width: 60px;">N°</th>
                    <th style="width: 120px;">Categoría</th>
                    <th style="width: 100px;">Código</th>
                    <th style="width: 250px;">Descripción del Utensilio</th>
                    <th style="width: 80px;">Unidad</th>
                    <th style="width: 100px;">Inv. Inicial</th>
                    <th style="width: 120px;">Unidades Contadas</th>
                    <th style="width: 100px;">Diferencia</th>
                </tr>
            </thead>
            <tbody id="kardexTableBody">
                @foreach (var detalle in Model.Detalles)
                {
                    var rowClass = detalle.TieneFaltantes ? "row-faltantes" : "";
                    var completeClass = detalle.EstaCompleto ? "row-complete" : "";
                    
                    <tr class="@rowClass @completeClass" data-detalle-id="@detalle.Id" data-categoria="@detalle.Categoria">
                        <td class="td-numero">@detalle.Orden</td>
                        <td class="td-categoria">@detalle.Categoria</td>
                        <td class="td-codigo">@detalle.Codigo</td>
                        <td class="td-nombre">@detalle.Nombre</td>
                        <td class="td-unidad">@detalle.Unidad</td>
                        <td class="td-readonly">@detalle.InventarioInicial</td>
                        <td class="td-editable">
                            <input type="number" 
                                   class="input-unidades" 
                                   data-detalle-id="@detalle.Id"
                                   value="@(detalle.UnidadesContadas?.ToString() ?? "")"
                                   step="1"
                                   min="0"
                                   placeholder="0" />
                        </td>
                        <td class="td-calculado td-diferencia" data-tiene-faltantes="@detalle.TieneFaltantes.ToString().ToLower()">
                            @detalle.Diferencia
                            @if (detalle.TieneFaltantes)
                            {
                                <button type="button" 
                                        class="btn-justificar" 
                                        onclick="openFaltantesModal(@detalle.Id, '@detalle.Nombre', @detalle.Diferencia)"
                                        title="Justificar faltantes">
                                    <i class="fa-solid fa-file-lines"></i>
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Botones de acción -->
<div class="content-card" style="margin-top: 1rem;">
    <div class="card-body">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <a asp-action="MiKardex" class="btn btn-secondary">
                <i class="fa-solid fa-arrow-left"></i>
                Volver
            </a>
            <button type="button" class="btn btn-primary" onclick="openSiguienteModal()" id="btnSiguiente">
                <i class="fa-solid fa-arrow-right"></i>
                Siguiente
            </button>
        </div>
    </div>
</div>

<!-- Modal de Descripción de Faltantes -->
<div id="faltantesModal" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 540px;">
        <div class="modal-header">
            <div>
                <h2 class="modal-title">Descripción de Faltantes (Requerido)</h2>
                <p class="modal-subtitle" id="faltantesSubtitulo">Especifique qué pasó con los faltantes</p>
            </div>
            <button class="modal-close" onclick="closeModal('faltantesModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="faltantesDetalleId" />
            
            <div style="background: #FEF3C7; border-left: 3px solid #F59E0B; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                <div style="font-size: 13px; color: #92400E;">
                    <strong style="display: block; margin-bottom: 0.5rem;">
                        <i class="fa-solid fa-exclamation-triangle"></i>
                        Se detectaron <span id="faltantesCantidad">0</span> unidad(es) faltante(s)
                    </strong>
                    <p style="margin: 0; font-size: 12px; line-height: 1.6;">
                        <strong>Ejemplo:</strong> 3 platos tendidos rotos durante el servicio, 2 copas de vino tinto extraviadas, 1 mantel manchado enviado a lavandería
                    </p>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Descripción de faltantes <span style="color: red;">*</span></label>
                <textarea id="faltantesDescripcion" 
                          class="form-control" 
                          rows="4"
                          placeholder="Ej: 3 platos tendidos rotos durante el servicio, 2 copas de vino tinto extraviadas..."
                          maxlength="500"
                          required></textarea>
                <small style="color: #64748B; font-size: 12px; display: block; margin-top: 0.375rem;">
                    Debe completar este campo antes de continuar
                </small>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeModal('faltantesModal')">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnGuardarFaltantes" onclick="guardarDescripcionFaltantes()">
                <i class="fa-solid fa-floppy-disk"></i>
                Guardar
            </button>
        </div>
    </div>
</div>

<!-- Modal de Siguiente/Completar -->
<div id="siguienteModal" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 540px;">
        <div class="modal-header">
            <div>
                <h2 class="modal-title">Siguiente: Personal Presente</h2>
                <p class="modal-subtitle">Revisa los datos antes de continuar</p>
            </div>
            <button class="modal-close" onclick="closeModal('siguienteModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="validacionResultado"></div>
            
            <div class="form-group">
                <label class="form-label">Observaciones generales (opcional)</label>
                <textarea id="observacionesGenerales" 
                          class="form-control" 
                          rows="3"
                          placeholder="Ej: Se detectaron varios utensilios con desgaste..."
                          maxlength="500"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeModal('siguienteModal')">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnConfirmarSiguiente" onclick="confirmarSiguiente()">
                <i class="fa-solid fa-arrow-right"></i>
                Siguiente: Personal Presente
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const KARDEX_ID = @Model.Id;
    </script>
    <script src="~/js/kardex-salon.js" asp-append-version="true"></script>
}