@model Puerto92.ViewModels.KardexBebidasRevisionViewModel
@{
    ViewData["Title"] = "Revisión de Kardex de Bebidas";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/kardex-revision.css" asp-append-version="true" />
}

<!-- Page Header -->
<div class="page-header">
    <div>
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
            <i class="fa-solid fa-wine-glass" style="color: #8B5CF6; font-size: 24px;"></i>
            <h1 class="page-title">Revisión de Kardex de Bebidas</h1>
        </div>
        <p class="page-subtitle">
            @Model.Fecha.ToString("dddd, dd 'de' MMMM 'de' yyyy", new System.Globalization.CultureInfo("es-ES"))
        </p>
    </div>
</div>

<!-- Información del Mozo Responsable -->
<div class="content-card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
        <div>
            <h2 class="card-title">Mozo Responsable</h2>
            <p class="card-subtitle">Empleado asignado y estado de envío</p>
        </div>
    </div>
    <div class="card-body">
        <div class="cocineros-grid">
            <div class="cocinero-card" style="border-color: #8B5CF6;">
                <div class="cocinero-header" style="color: #8B5CF6; border-color: #EDE9FE;">
                    <i class="fa-solid fa-user" style="color: #8B5CF6;"></i>
                    <span>Mozo de Bebidas</span>
                </div>
                <div class="cocinero-info">
                    <div class="cocinero-nombre">@Model.EmpleadoNombre</div>
                    <div class="cocinero-fecha">
                        <i class="fa-regular fa-clock"></i>
                        Enviado: @Model.FechaEnvio?.ToString("hh:mm tt")
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estadísticas -->
<div class="estadisticas-revision">
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);">
            <i class="fa-solid fa-wine-glass"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">@Model.TotalProductos</div>
            <div class="stat-label">Total de Bebidas</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon stat-warning">
            <i class="fa-solid fa-exclamation-triangle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">@Model.ProductosConDiferencia</div>
            <div class="stat-label">Con Diferencias >10%</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon stat-info">
            <i class="fa-solid fa-users"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">@Model.PersonalPresente.Count</div>
            <div class="stat-label">Personal Presente</div>
        </div>
    </div>
</div>

<!-- Instrucciones -->
<div class="content-card" style="margin-bottom: 1.5rem;">
    <div class="card-body" style="background: #F5F3FF; border-left: 3px solid #8B5CF6;">
        <div style="display: flex; align-items: start; gap: 0.75rem;">
            <i class="fa-solid fa-info-circle" style="color: #7C3AED; font-size: 20px; margin-top: 2px;"></i>
            <div style="flex: 1;">
                <h3 style="font-size: 15px; font-weight: 600; color: #5B21B6; margin-bottom: 0.5rem;">
                    Instrucciones de revisión
                </h3>
                <ul style="font-size: 13px; color: #5B21B6; line-height: 1.8; margin: 0; padding-left: 1.5rem;">
                    <li>Revise el <strong>inventario inicial</strong> y los <strong>ingresos</strong> de cada producto</li>
                    <li>Verifique el <strong>conteo por ubicación</strong>: Almacén, Refri 1, Refri 2, Refri 3</li>
                    <li>El <strong>conteo final</strong> es la suma de todas las ubicaciones</li>
                    <li>Las <strong>ventas</strong> se calculan: Inv. Inicial + Ingresos - Conteo Final</li>
                    <li>Los productos con <strong>diferencia >10%</strong> están resaltados en amarillo</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Buscador y Filtros -->
<div class="content-card" style="margin-bottom: 1rem;">
    <div class="card-body" style="padding: 1rem;">
        <div style="display: flex; gap: 1rem; align-items: center;">
            <div style="flex: 1; max-width: 400px;">
                <div class="search-box">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" 
                           id="searchProducto" 
                           class="form-control" 
                           placeholder="Buscar producto por código o nombre..."
                           style="padding-left: 2.5rem;" />
                </div>
            </div>
            <div>
                <select id="filtroCategoria" class="form-select" onchange="filtrarPorCategoria(this.value)">
                    <option value="">Todas las categorías</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de Bebidas -->
<div class="content-card">
    <div class="card-header">
        <div>
            <h2 class="card-title">Inventario de Bebidas</h2>
            <p class="card-subtitle">Conteo por ubicación revisado por el mozo</p>
        </div>
    </div>
    <div class="card-body" style="padding: 0;">
        <div style="overflow-x: auto;">
            <table class="kardex-revision-table">
                <thead>
                    <tr>
                        <th style="width: 120px;">Categoría</th>
                        <th style="width: 80px;">Código</th>
                        <th style="width: 200px;">Descripción</th>
                        <th style="width: 70px;">Unidad</th>
                        <th style="width: 90px;">Inv. Inicial</th>
                        <th style="width: 80px;">Ingresos</th>
                        <th style="width: 90px;">Almacén</th>
                        <th style="width: 90px;">Refri 1</th>
                        <th style="width: 90px;">Refri 2</th>
                        <th style="width: 90px;">Refri 3</th>
                        <th style="width: 100px;">Conteo Final</th>
                        <th style="width: 90px;">Ventas</th>
                        <th style="width: 110px;">Diferencia %</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var detalle in Model.Detalles)
                    {
                        var rowClass = detalle.TieneDiferenciaSignificativa ? "row-diferencia" : "";
                        
                        <tr class="@rowClass" data-producto="@detalle.Descripcion @detalle.Codigo" data-categoria="@detalle.Categoria">
                            <td class="td-categoria">
                                <span class="badge badge-categoria" style="background: rgba(139, 92, 246, 0.1); color: #6D28D9;">
                                    @detalle.Categoria
                                </span>
                            </td>
                            <td class="td-codigo">@detalle.Codigo</td>
                            <td class="td-nombre">@detalle.Descripcion</td>
                            <td class="td-unidad">@detalle.Unidad</td>
                            <td class="td-readonly">@detalle.InventarioInicial.ToString("0.##")</td>
                            <td class="td-readonly">@detalle.Ingresos.ToString("0.##")</td>
                            <td class="td-stock" style="background: rgba(59, 130, 246, 0.05);">
                                @(detalle.ConteoAlmacen?.ToString("0.##") ?? "-")
                            </td>
                            <td class="td-stock" style="background: rgba(139, 92, 246, 0.05);">
                                @(detalle.ConteoRefri1?.ToString("0.##") ?? "-")
                            </td>
                            <td class="td-stock" style="background: rgba(139, 92, 246, 0.05);">
                                @(detalle.ConteoRefri2?.ToString("0.##") ?? "-")
                            </td>
                            <td class="td-stock" style="background: rgba(139, 92, 246, 0.05);">
                                @(detalle.ConteoRefri3?.ToString("0.##") ?? "-")
                            </td>
                            <td class="td-promedio">
                                <strong>@detalle.ConteoFinal.ToString("0.##")</strong>
                            </td>
                            <td class="td-readonly" style="font-weight: 600; color: #0369A1;">
                                @detalle.Ventas.ToString("0.##")
                            </td>
                            <td class="td-diferencia">
                                @if (detalle.TieneDiferenciaSignificativa)
                                {
                                    <span class="badge-diferencia">
                                        <i class="fa-solid fa-exclamation-triangle"></i>
                                        @detalle.DiferenciaPorcentual?.ToString("0.##")%
                                    </span>
                                }
                                else if (detalle.DiferenciaPorcentual.HasValue)
                                {
                                    <span style="color: #10B981; font-weight: 600;">
                                        @detalle.DiferenciaPorcentual?.ToString("0.##")%
                                    </span>
                                }
                                else
                                {
                                    <span style="color: #64748B;">-</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Observaciones -->
@if (!string.IsNullOrEmpty(Model.Observaciones))
{
    <div class="content-card" style="margin-top: 1.5rem;">
        <div class="card-header">
            <div>
                <h2 class="card-title">Observaciones del Mozo</h2>
                <p class="card-subtitle">Comentarios adicionales</p>
            </div>
        </div>
        <div class="card-body">
            <div style="background: #F5F3FF; border-left: 3px solid #8B5CF6; padding: 1rem; border-radius: 8px;">
                <div style="white-space: pre-wrap; color: #5B21B6; font-size: 14px; line-height: 1.6;">@Model.Observaciones</div>
            </div>
        </div>
    </div>
}

<!-- Personal Presente -->
<div class="content-card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <div>
            <h2 class="card-title">Personal Presente</h2>
            <p class="card-subtitle">Empleados que estuvieron durante el turno</p>
        </div>
    </div>
    <div class="card-body">
        <div class="personal-presente-list">
            @foreach (var empleado in Model.PersonalPresente)
            {
                <div class="personal-presente-item @(empleado.EsResponsablePrincipal ? "responsable" : "")">
                    <i class="fa-solid @(empleado.EsResponsablePrincipal ? "fa-star" : "fa-user")"></i>
                    <div>
                        <div class="personal-nombre">
                            @empleado.NombreCompleto
                            @if (empleado.EsResponsablePrincipal)
                            {
                                <span class="badge-responsable">Responsable</span>
                            }
                        </div>
                        <div class="personal-rol">@empleado.Rol</div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Botones de acción -->
<div class="content-card" style="margin-top: 1.5rem;">
    <div class="card-body">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
            <a asp-action="PendientesDeRevision" class="btn btn-secondary">
                <i class="fa-solid fa-arrow-left"></i>
                Volver a Pendientes
            </a>
            <div style="display: flex; gap: 0.75rem;">
                <button type="button" class="btn btn-danger" onclick="abrirModalRechazar()">
                    <i class="fa-solid fa-xmark"></i>
                    Rechazar
                </button>
                <button type="button" class="btn btn-success" onclick="abrirModalAprobar()">
                    <i class="fa-solid fa-check"></i>
                    Aprobar
                </button>
            </div>
        </div>
    </div>
</div>

@* Cargar Modales usando partials *@
<partial name="Modals/_AprobarKardexModal" />
<partial name="Modals/_RechazarKardexModal" />

@section Scripts {
    <script>
        const KARDEX_ID = @Model.Id;
        const TIPO_KARDEX = 'Mozo Bebidas';
        const KARDEX_IDS = [@Model.Id];
        
        // Configurar mensajes del modal al cargar
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('aprobarModalSubtitle').textContent = 'Confirmación para Kardex de Bebidas';
            document.getElementById('aprobarModalMensaje').textContent = 'Se aprobará el kardex de bebidas';
            document.getElementById('aprobarModalDetalle').textContent = 'El mozo @Model.EmpleadoNombre recibirá una notificación de aprobación';
            
            document.getElementById('rechazarModalSubtitle').textContent = 'Rechazo de Kardex de Bebidas';
            document.getElementById('rechazarModalMensaje').textContent = 'Se rechazará el kardex de bebidas';
            document.getElementById('rechazarModalDetalle').textContent = 'El mozo deberá corregir y reenviar el kardex';
        });
        
        // Poblar select de categorías
        document.addEventListener('DOMContentLoaded', function() {
            const categorias = new Set();
            document.querySelectorAll('[data-categoria]').forEach(row => {
                const cat = row.dataset.categoria;
                if (cat) categorias.add(cat);
            });
            
            const select = document.getElementById('filtroCategoria');
            if (select) {
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.appendChild(option);
                });
            }
        });
        
        function filtrarPorCategoria(categoria) {
            document.querySelectorAll('.kardex-revision-table tbody tr').forEach(row => {
                const rowCat = row.dataset.categoria;
                row.style.display = !categoria || rowCat === categoria ? '' : 'none';
            });
        }
    </script>
    <script src="~/js/kardex-revision.js" asp-append-version="true"></script>
    <script>
        // Búsqueda específica para productos
        document.getElementById('searchProducto')?.addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase().trim();
            document.querySelectorAll('.kardex-revision-table tbody tr').forEach(row => {
                const text = row.dataset.producto?.toLowerCase() || '';
                row.style.display = text.includes(term) || term === '' ? '' : 'none';
            });
        });
    </script>
}
